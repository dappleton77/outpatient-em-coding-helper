<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inpatient E/M Coding Helper for Levels 1-3</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            max-width: 900px;
            margin: auto;
            padding: 20px;
            background-color: #f4f7fa;
            color: #333;
        }

        h1, h2, h3 {
            color: #2c3e50;
        }

        .step {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }

        .step.active {
            display: block;
        }

        label, input, select {
            display: block;
            margin-bottom: 10px;
        }

        input[type="radio"], input[type="checkbox"] {
            display: inline;
            margin-right: 10px;
        }

        button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        button:hover {
            background-color: #219653;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 5px solid #27ae60;
            border-radius: 5px;
            font-size: 16px;
            display: none;
        }

        .examples {
            font-size: 0.9em;
            color: #555;
            margin-left: 20px;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            color: #777;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        /* Accessibility */
        :focus {
            outline: 2px solid #27ae60;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body { max-width: 100%; padding: 10px; }
            .step { padding: 15px; }
            button { width: 100%; margin-bottom: 10px; margin-right: 0; }
        }

        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <h1>Inpatient E/M Coding Helper for Levels 1-3</h1>
    <p>This tool guides you through assessing MDM for initial (99221-99223) or subsequent (99231-99233) inpatient visits. Click through the steps.</p>
    
    <div id="step1" class="step active" aria-labelledby="step1-heading">
        <h2 id="step1-heading">Step 1: Visit Type</h2>
        <label for="visitType">Select the type of visit:</label>
        <select id="visitType">
            <option value="initial">Initial (99221-99223)</option>
            <option value="subsequent">Subsequent (99231-99233)</option>
        </select>
        <button onclick="nextStep(1)">Next</button>
    </div>
    
    <div id="step2" class="step" aria-labelledby="step2-heading">
        <h2 id="step2-heading">Step 2: Number and Complexity of Problems Addressed</h2>
        <p>Select the option that best matches your encounter. Examples are provided for each level.</p>
        <input type="radio" name="problems" value="low" id="problemsLow">
        <label for="problemsLow">Low Level</label>
        <div class="examples">
            - 1 self-limited or minor problem<br>
            - Or 2+ self-limited/minor problems<br>
            - Or 1 stable chronic illness (e.g., stable hypertension)<br>
            - Or 1 acute, uncomplicated illness/injury (e.g., simple chest pain resolved with minimal intervention)
        </div>
        
        <input type="radio" name="problems" value="moderate" id="problemsModerate">
        <label for="problemsModerate">Moderate Level</label>
        <div class="examples">
            - 1+ chronic illnesses with exacerbation/progression/side effects (e.g., heart failure flare-up requiring adjustment)<br>
            - Or 2+ stable chronic illnesses (e.g., CAD and atrial fibrillation, both controlled)<br>
            - Or 1 undiagnosed new problem with uncertain prognosis (e.g., new unexplained dyspnea)<br>
            - Or 1 acute illness with systemic symptoms (e.g., pneumonia affecting breathing)<br>
            - Or 1 acute complicated injury (e.g., fall with rib fracture in anticoagulated patient)
        </div>
        
        <input type="radio" name="problems" value="high" id="problemsHigh">
        <label for="problemsHigh">High Level</label>
        <div class="examples">
            - 1+ chronic illnesses with severe exacerbation/progression/side effects (e.g., decompensated heart failure with pulmonary edema)<br>
            - Or 1 acute/chronic illness/injury threatening life or function (e.g., STEMI, severe arrhythmia causing shock)
        </div>
        
        <p id="problems-error" class="error-message">Please select an option to proceed.</p>
        <button onclick="prevStep(2)">Back</button>
        <button id="next2" onclick="nextStep(2)" disabled>Next</button>
    </div>
    
    <div id="step3" class="step" aria-labelledby="step3-heading">
        <h2 id="step3-heading">Step 3: Amount and/or Complexity of Data Reviewed and Analyzed</h2>
        <p>Check all that apply. The level will be determined based on categories met.</p>
        
        <h3>Category 1: Tests, Notes, and Historian</h3>
        <label for="dataReviewExternal"><input type="checkbox" id="dataReviewExternal"> Review of external notes from unique source</label>
        <label for="dataReviewTests"><input type="checkbox" id="dataReviewTests"> Review of unique test results</label>
        <label for="dataOrderTests"><input type="checkbox" id="dataOrderTests"> Ordering of unique tests</label>
        <label for="dataHistorian"><input type="checkbox" id="dataHistorian"> Assessment requiring independent historian (e.g., family input)</label>
        
        <h3>Category 2: Independent Interpretation</h3>
        <label for="dataInterpretation"><input type="checkbox" id="dataInterpretation"> Independent interpretation of tests not separately reported (e.g., personally reviewing an ECG)</label>
        
        <h3>Category 3: Discussion</h3>
        <label for="dataDiscussion"><input type="checkbox" id="dataDiscussion"> Discussion with external provider/source (e.g., consulting pulmonologist)</label>
        
        <p><em>Levels:</em><br>
        - Low: Minimal or limited (e.g., any 2 from Category 1 or independent historian)<br>
        - Moderate: Moderate (e.g., any 3 from Category 1, or Category 2, or Category 3)<br>
        - High: Extensive (meet 2 of 3 categories)
        </p>
        
        <button onclick="prevStep(3)">Back</button>
        <button onclick="nextStep(3)">Next</button>
    </div>
    
    <div id="step4" class="step" aria-labelledby="step4-heading">
        <h2 id="step4-heading">Step 4: Risk of Complications and/or Morbidity or Mortality</h2>
        <p>Select the option that best matches. Examples included.</p>
        <input type="radio" name="risk" value="low" id="riskLow">
        <label for="riskLow">Low Level</label>
        <div class="examples">
            - Minimal (e.g., rest, over-the-counter meds)<br>
            - Or low (e.g., simple wound care)
        </div>
        
        <input type="radio" name="risk" value="moderate" id="riskModerate">
        <label for="riskModerate">Moderate Level</label>
        <div class="examples">
            - Prescription drug management (e.g., adjusting beta-blockers)<br>
            - Decision for minor surgery with risk factors (e.g., pacemaker placement in frail patient)<br>
            - Elective major surgery without risk factors (e.g., routine CABG planning)<br>
            - Treatment limited by social determinants (e.g., homelessness affecting med adherence)
        </div>
        
        <input type="radio" name="risk" value="high" id="riskHigh">
        <label for="riskHigh">High Level</label>
        <div class="examples">
            - Drug therapy needing intensive monitoring (e.g., IV inotropes for cardiogenic shock)<br>
            - Elective major surgery with risk factors (e.g., urgent valve replacement in high-risk patient)<br>
            - Emergency major surgery (e.g., immediate PCI for acute MI)<br>
            - Decision to hospitalize/escalate care (e.g., ICU transfer for unstable angina)<br>
            - Decision not to resuscitate/de-escalate due to poor prognosis (e.g., end-stage cardiomyopathy)
        </div>
        
        <p id="risk-error" class="error-message">Please select an option to proceed.</p>
        <button onclick="prevStep(4)">Back</button>
        <button id="next4" onclick="nextStep(4)" disabled>Next</button>
    </div>
    
    <div id="step5" class="step" aria-labelledby="step5-heading">
        <h2 id="step5-heading">Step 5: Time Override (Optional)</h2>
        <p>If using time instead of (or in addition to) MDM, enter total minutes spent on the date of encounter (includes chart review, counseling, etc.).</p>
        <label for="time">Total minutes (e.g., 60):</label>
        <input type="number" id="time" min="0">
        <p id="time-error" class="error-message">Please enter a valid non-negative number.</p>
        <p><em>Thresholds:</em><br>
        - Initial: Level 2 ≥55 min, Level 3 ≥75 min<br>
        - Subsequent: Level 2 ≥35 min, Level 3 ≥50 min
        </p>
        
        <button onclick="prevStep(5)">Back</button>
        <button onclick="calculateLevel()">Calculate Level</button>
    </div>
    
    <div id="result" aria-live="polite"></div>
    
    <button id="resetButton" onclick="resetForm()" style="display: none; background-color: #e74c3c; margin-top: 20px;">Reset and Start Over</button>
    
    <footer>
        <p>This is an educational tool only. Consult official guidelines and your billing team.</p>
        <p>For full details: <a href="https://www.ama-assn.org/system/files/2023-e-m-descriptors-guidelines.pdf">AMA Guidelines</a> | <a href="https://www.aan.com/siteassets/home-page/tools-and-resources/practicing-neurologist--administrators/billing-and-coding/cpt--em/2023-cpt-revised-mdm-grid.pdf">MDM Grid</a></p>
    </footer>
    
    <script>
        // CONFIG for easy updates
        const CONFIG = {
            timeThresholds: {
                initial: [0, 55, 75],  // Level 1: <55, 2: >=55, 3: >=75
                subsequent: [0, 35, 50]
            },
            codes: {
                initial: ['99221', '99222', '99223'],
                subsequent: ['99231', '99232', '99233']
            }
        };

        function showError(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
        }

        function nextStep(current) {
            let canProceed = true;
            if (current === 2) {
                canProceed = !!document.querySelector('input[name="problems"]:checked');
                showError('problems-error', !canProceed);
            }
            if (current === 4) {
                canProceed = !!document.querySelector('input[name="risk"]:checked');
                showError('risk-error', !canProceed);
            }
            if (!canProceed) return;
            
            console.log(`Switching from step ${current} to ${current + 1}`);  // Debug: Check console after click
            document.getElementById(`step${current}`).classList.remove('active');
            document.getElementById(`step${current + 1}`).classList.add('active');
        }

        function prevStep(current) {
            document.getElementById(`step${current}`).classList.remove('active');
            document.getElementById(`step${current - 1}`).classList.add('active');
            showError('problems-error', false);
            showError('risk-error', false);
        }

        // Enable buttons on change
        document.querySelectorAll('input[name="problems"]').forEach(input => {
            input.addEventListener('change', () => {
                document.getElementById('next2').disabled = false;
                showError('problems-error', false);
            });
        });
        document.querySelectorAll('input[name="risk"]').forEach(input => {
            input.addEventListener('change', () => {
                document.getElementById('next4').disabled = false;
                showError('risk-error', false);
            });
        });

        function validateTime(timeValue) {
            const time = parseInt(timeValue, 10);
            if (isNaN(time) || time < 0) {
                showError('time-error', true);
                return 0;
            }
            showError('time-error', false);
            return time;
        }

        function calculateDataLevel() {
            const cat1Count = [ 'dataReviewExternal', 'dataReviewTests', 'dataOrderTests' ].reduce((count, id) => count + (document.getElementById(id).checked ? 1 : 0), 0);
            const historian = document.getElementById('dataHistorian').checked;
            const cat1Total = cat1Count + (historian ? 1 : 0);  // Historian counts in Cat1 for levels
            const cat2 = document.getElementById('dataInterpretation').checked;
            const cat3 = document.getElementById('dataDiscussion').checked;
            const categoriesMet = (cat1Total >= 3 ? 1 : 0) + (cat2 ? 1 : 0) + (cat3 ? 1 : 0);

            if (cat1Count >= 1 || historian) return { level: 'low', met: categoriesMet };
            if (cat1Total >= 3 || cat2 || cat3) return { level: 'moderate', met: categoriesMet };
            if (categoriesMet >= 2) return { level: 'high', met: categoriesMet };
            return { level: 'low', met: categoriesMet };
        }

        function calculateTimeLevel(visitType, time) {
            const thresholds = CONFIG.timeThresholds[visitType];
            if (time >= thresholds[2]) return 3;
            if (time >= thresholds[1]) return 2;
            return 1;
        }

        function calculateMDMLevel(problems, dataLevel, risk) {
            const levels = { low: 1, moderate: 2, high: 3 };
            const nums = [levels[problems], levels[dataLevel], levels[risk]];
            nums.sort((a, b) => b - a);  // Descending
            return nums[1] || 1;  // Middle value (for 3 elements); min 1 for inpatient
        }

        function calculateLevel() {
            const visitType = document.getElementById('visitType').value;
            const problems = document.querySelector('input[name="problems"]:checked')?.value || 'low';
            const risk = document.querySelector('input[name="risk"]:checked')?.value || 'low';
            const timeValue = document.getElementById('time').value;
            const time = validateTime(timeValue);

            const data = calculateDataLevel();
            const mdmLevel = calculateMDMLevel(problems, data.level, risk);
            const timeLevel = calculateTimeLevel(visitType, time);
            const finalLevel = Math.max(mdmLevel, timeLevel);

            const codes = CONFIG.codes[visitType];
            const code = codes[finalLevel - 1];

            document.getElementById('result').innerHTML = `
                <strong>Suggested Level: ${finalLevel} (Code: ${code})</strong><br>
                MDM Breakdown:<br>
                - Problems: ${problems.charAt(0).toUpperCase() + problems.slice(1)}<br>
                - Data: ${data.level.charAt(0).toUpperCase() + data.level.slice(1)} (Categories met: ${data.met})<br>
                - Risk: ${risk.charAt(0).toUpperCase() + risk.slice(1)}<br>
                Use the higher of MDM (Level ${mdmLevel}) or Time (Level ${timeLevel}).
            `;

            document.getElementById('step5').classList.remove('active');
            document.getElementById('result').style.display = 'block';
            document.getElementById('resetButton').style.display = 'block';
        }

        function resetForm() {
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.checked = false);
            document.getElementById('time').value = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').style.display = 'none';
            document.getElementById('resetButton').style.display = 'none';
            document.querySelectorAll('.step').forEach((step, i) => {
                step.classList.remove('active');
                if (i === 0) step.classList.add('active');  // Step1 active
            });
            document.getElementById('next2').disabled = true;
            document.getElementById('next4').disabled = true;
            showError('problems-error', false);
            showError('risk-error', false);
            showError('time-error', false);
        }
    </script>
</body>
</html>